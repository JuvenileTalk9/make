# gcc

makeの勉強に移る前に、前提知識となるgcc、g++の使い方を復習します。

なお、ここではC++のプログラムを扱うため、```g++```コマンドを使用します。gccとg++の違いは以下です。

||\*.cへの挙動|\*.cppへの挙動|std C++ライブラリへの自動リンク|
|:--|:--|:--|:--|
|gcc|C言語としてコンパイル|C++言語としてコンパイル|しない|
|g++|C++言語としてコンパイル|C++言語としてコンパイル|する|

オプションの使い方などは基本的に同じです。Cをコンパイルしたい場合は```gcc```を、C++をコンパイルしたい場合は```g++```を使用してください。

もしgccでstd C++ライブラリへリンクしたい場合は、```gcc -lstdc++```のように、```-lstdc++```オプションを使用してください。また、これ以外にもg++はいくつかのマクロが追加されています。

## 基本のコンパイル

以下のようなプログラム```main.cpp```があるとします。

```c++
#include <iostream>

int main(int argc, char** argv) {

    std::cout << "Hello gcc" << std::endl;

    return 0;
}
```

これをコンパイルし実行ファイルにするためには、下記のコマンドを実行します。

```sh
# 基本のコンパイル
$ g++ main.cpp
# gccでC++をコンパイルしたい場合は、-lstdc++オプションを付ける
$ gcc main.cpp -lstdc++
```

実行すると、a.outという実行ファイルが生成されます。

```sh
$ ./a.out
Hello gcc
```
## 出力する実行ファイルに名前をつける

a.outはわかりにくいので、```-o```オプションで出力する実行ファイルのファイル名を指定します。

```sh
$ g++ main.cpp -o hello_gcc
$ ./hello_gcc
Hello gcc
```

## 複数ファイルをコンパイル

以下のように複数ファイルにまたがったプログラムだとします。

```c++
// main.cpp
#include <iostream>

int add(int a, int b);

int main(int argc, char** argv) {

    std::cout << "2 + 3 = " << add(2, 3) << std::endl;

    return 0;
}
```

```c++
// calc_add.cpp
int add(int a, int b) {
    return a + b;
}
```

この場合、2つのファイルを指定することでコンパイルできます。

```sh
$ g++ main.cpp calc_add.cpp -o main_add                                                                          
$ ./main_add
2 + 3 = 5
```

なお、指定したインクルードディレクトリ内のヘッダファイルをインクルードした場合は、```int add(int a, int b);```のように関数の定義を書く必要はありません。この場合も、先程の例と同じ結果になります。ヘッダファイルは```g++```のコマンドオプションに含める必要はありません。指定したインクルードディレクトリ内（""で囲った場合はカレントディレクトリ内も検索対象に含める）から同一ファイルを自動的に探します。インクルードディレクトリを追加する方法は後ほど説明します。

```c++
// main2.cpp
#include <iostream>
#include "calc_add.hpp" // new

// int add(int a, int b); delete

int main(int argc, char** argv) {

    std::cout << "2 + 3 = " << add(2, 3) << std::endl;

    return 0;
}
```

```c++
// calc_add.hpp
int add(int a, int b);  // new
```

## オブジェクトファイルを作る

大規模なプログラムの場合、コンパイルする*.cppファイルが複数になります。しかし上記のコンパイルの方法では、ただ1つのソースファイルを修正した場合でも、残りのすべてのファイルもコンパイルし直す必要があります。

そのようなムダを回避するために、それぞれのソースファイルを独立したオブジェクトファイルとしてコンパイルする方法が一般的です。これにより、1つのソースファイルを修正した場合、そのソースファイルだけコンパイルすることが可能です。

gccでは```-c```オプションでオブジェクトファイルを生成します。オブジェクトファイルは、```.o```というファイルで出力されます。

```
$ g++ -c main.cpp calc_add.cpp
$ ls
main.cpp  main.o  calc_add.cpp  calc_add.o
```

ただし、オブジェクトファイルはバラバラのソースファイルをコンパイルしたものであり、それ単体では動作しません。実行可能なファイルにするためには、ばらばらになったオブジェクトファイルを結合し、1つのプログラムにする必要があります。この作業をリンクと呼びます。

## オブジェクトファイルをリンクする

生成したオブジェクトファイルは、複数のソースファイルをコンパイルするときと同様のコマンドでリンクすることができます。

```sh
$ g++ main.o calc_add.o -o main_add
$ ./main_add
2 + 3 = 5
```

## インクルードディレクトリを追加する

ソースファイルに```#include <hogehoge.hpp>```と記述すると、コンパイラはデフォルトで指定されたディレクトリから```hogehoge.hpp```を探しに行きます。```#include "fugafuga.hpp"```と記述した場合は、さらにコンパイルするファイルと同じディレクトリを優先的に探しに行きます。

このとき、ダウンロードしてきた便利なライブラリなど、インクルードしたいファイルが全くことなるディレクトリに存在する場合、```#include "../../../hoge/fuga.hpp"```のように複雑な指定の方法になってしまい、移植性も下がってしまいます。

そこで、```-I```オプションでインクルードディレクトリを追加します。

例として、メイン関数があるディレクトリと全く異なるディレクトリ```/home/gcc/my_include```に```calc_add.hpp```が存在するとします。インクルードするときは、実装の内容は気にせず、ヘッダーファイルの定義を参照するので、calc_add.hppのみ存在すれば十分です。

メイン分では、```<>```でインクルードファイルを指定します。

```c++
// main.cpp
#include <iostream>
#include <calc_add.hpp>

int main(int argc, char** argv) {

    std::cout << "2 + 3 = " << add(2, 3) << std::endl;

    return 0;
}
```

```/home/gcc/my_include```を```-I```オプションで追加し、コンパイルしてオブジェクトファイルを生成します。

```sh
$ g++ -c main.cpp -I/home/gcc/my_include
$ ls
main.cpp  main.o
```

ただし、実行ファイルを生成するときは、```calc_add.cpp```をコンパイルしたファイルとのリンクが必要になります。ライブラリととリンクする方法は、以下の3通りあります。

|リンク方法|対象ライブラリ|拡張子|リンクタイミング|
|:--|:--|:--|:--|
|静的リンク|静的ライブラリ|.a|ビルド時|
|動的リンク|共有ライブラリ|.so|実行開始時|
|動的ロード|共有ライブラリ|.so|実行中の任意のタイミング|

ここでは動的ロードを除く2種類のリンク方法について説明します。

## 静的ライブラリを使う

静的ライブラリは、複数のオブジェクトファイルをまとめたアーカイブファイルです。複数のオブジェクトファイルとリンクする必要があるとき、静的ライブラリを使わない場合、```g++ main.cpp a.o b.o c.o```とコマンドが冗長になっていまいます。静的ライブラリを使うと、```g++ main.cpp calc_add.a```と簡潔に記述できます。

例として、加減乗除を行うプログラム```add.cpp```、```sub.cpp```、```mul.cpp```、```div.cpp```があるとし、これを静的ライブラリとして保存します。静的ライブラリは、libを接頭語とする命名規則があります。

```sh
$ ls
add.cpp  div.cpp  mul.cpp  sub.cpp
$ g++ -c *.cpp
$ ar r libcalc.a *.o
$ ar t libcalc.a
add.o
div.o
mul.o
sub.o
```

```ar```コマンドの基本的な構文は以下です。

```sh
ar [-]opcode[mod] archive [files..]
```

opcodeには必ず1つ操作コードを指定する必要があり、さらに操作コードの内容を少し変更（modify）する修飾子をつけることができます。代表的なの代表的なオプションは以下があります。

|操作コード|説明|
|:--|:--|
|d|すでに存在するメンバーを指定し、それを削除（delete）する。|
|r|アーカイブにファイルを挿入する。同名のファイルがすでにあれば置換（replace）する。|
|t|書庫の内容を表（table）で表示する。|
|x|すでに存在するメンバーを指定し、それを取り出す（eXtract）。|

|修飾子|説明|
|:--|:--|
|a|すでに存在するメンバーを1つ指定し、その前（after）に追加する。|
|b|すでに存在するメンバーを1つ指定し、その後（before）に追加する。|
|c|アーカイブを新規作成（create）する。すでに存在すればエラーメッセージが出る。|
|o|書庫からメンバーを取り出すとき、元（original）の日付を保持する。|

静的ライブラリをリンクするときは、```-L```オプションでリンクするライブラリがあるディレクトリを指定し、```-l```オプションでリンクするライブラリ名を指定します。```-l```オプションでの指定の仕方は少し特殊で、```-L```オプションで指定したディレクトリにある静的ライブラリ名から、接頭語のlibと拡張子の.aを除いたものです。

先程の```main.cpp```と```calc_add.hpp```の例の戻ります。前回作成した```calc_add.o```をライブラリ```libcalc.a```に追加し、main.oとリンクさせます。

```sh
# calc_add.oがあるディレクトリ~/my_libで以下実行
$ ar r libcalc.a calc_add.o

# main.oがあるディレクトリで以下実行
$ g++ main.o -L/home/gcc/my_lib -lcalc -o main_add
$ ./main_add
2 + 3 = 5
```

## 共有ライブラリを使う

外部ライブラリのプログラムとリンクするもう一つの方法は、共有ライブラリを使うことです。静的ライブラリの場合、ライブラリを修正したとき、そのライブラリを使っているすべてのプログラムを再コンパイルする必要があります。一方、共有ライブラリを修正しても、共有ライブラリだけのビルドで済みます。

共有ライブラリのコンパイルとリンクの方法は、静的ライブラリとほぼ同じです。コンパイルのときは、```--shared```オプションを追加で付与します。

```sh
$ ls
add.cpp  calc.hpp  main.cpp
$ g++ -shared add.cpp -o libadd.so
$ g++ -I./ -L./  main.cpp -ladd -o main
```

共有ライブラリと動的リンクさせる場合は、OSにリンク先のライブラリのパスを教える必要があります。ライブラリの指定の方法は以下で、優先度は値が高いほど優先度が高くなっています。

|優先度|方法|
|:--|:--|
|3|環境変数```LD_LIBRARY_PATH```で指定したディレクトリ|
|2|/etc/ld.so.cacheファイルで指定したディレクトリ|
|1|/lib と /usr/lib ディレクトリ|

今回は環境変数で指定します。

```sh
$ export LD_LIBRARY_PATH=`pwd`
$ ./main
2 + 3 = 5
```

なお、共有ライブラリが読み込まれているかは、```ldd```コマンドで確認できます。

```sh
ldd main
        linux-vdso.so.1 =>  (0x00007fff5a7e2000)
        libadd.so => /home/gcc/sample/libadd.so (0x00007fbc76545000)
        libstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007fbc7623e000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fbc75f3c000)
        libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fbc75d26000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fbc75958000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fbc76747000)
```

```/home/gcc/sample/libadd.so```を読み込んでいることが確認できます。

目次へ
